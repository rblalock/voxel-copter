<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxelCopter - Sprite Model Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #1a1a2e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-size: 12px;
            color: #88ff88;
        }
        input[type="range"] {
            width: 150px;
            accent-color: #00ff00;
        }
        input[type="color"] {
            width: 60px;
            height: 30px;
            border: 1px solid #00ff00;
            background: transparent;
        }
        select {
            background: #1a1a2e;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px;
        }
        .sprite-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .sprite-card {
            background: rgba(0, 50, 0, 0.3);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 10px;
        }
        .sprite-card h3 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #88ff88;
        }
        .sprite-canvas {
            display: block;
            margin: 0 auto;
            background: #2a2a4e;
            border: 1px solid #444;
            image-rendering: pixelated;
        }
        .sprite-info {
            margin-top: 10px;
            font-size: 11px;
            color: #66aa66;
            text-align: center;
        }
        .angle-strip {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .angle-strip canvas {
            border: 1px solid #333;
            image-rendering: pixelated;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .reference-images {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px dashed #444;
        }
        .reference-images img {
            max-width: 200px;
            border: 1px solid #444;
        }
        .comparison {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        .comparison-label {
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
        }
        #animationCanvas {
            display: block;
            margin: 20px auto;
            background: #2a2a4e;
            border: 2px solid #00ff00;
        }
    </style>
</head>
<body>
    <h1>VoxelCopter Sprite Model Viewer</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>Sprite Size: <span id="sizeValue">48</span>px</label>
            <input type="range" id="sizeSlider" min="12" max="120" value="48">
        </div>
        <div class="control-group">
            <label>Heading Angle: <span id="angleValue">0</span>°</label>
            <input type="range" id="angleSlider" min="0" max="360" value="0">
        </div>
        <div class="control-group">
            <label>Camera Angle: <span id="camAngleValue">0</span>°</label>
            <input type="range" id="camAngleSlider" min="0" max="360" value="0">
        </div>
        <div class="control-group">
            <label>Fog Factor: <span id="fogValue">0</span></label>
            <input type="range" id="fogSlider" min="0" max="100" value="0">
        </div>
        <div class="control-group">
            <label>Ambient Light: <span id="ambientValue">1.0</span></label>
            <input type="range" id="ambientSlider" min="20" max="100" value="100">
        </div>
        <div class="control-group">
            <label>Base Color</label>
            <input type="color" id="colorPicker" value="#4a5a4a">
        </div>
        <div class="control-group">
            <label>Background</label>
            <select id="bgSelect">
                <option value="#2a2a4e">Night</option>
                <option value="#87ceeb">Day Sky</option>
                <option value="#d4a574">Desert</option>
                <option value="#228b22">Forest</option>
                <option value="#4a4a4a">Gray</option>
            </select>
        </div>
    </div>

    <div class="section">
        <h2>Animation Preview</h2>
        <canvas id="animationCanvas" width="800" height="200"></canvas>
    </div>

    <div class="section">
        <h2>Aircraft</h2>
        <div class="sprite-grid" id="aircraftGrid"></div>
    </div>

    <div class="section">
        <h2>Ground Units</h2>
        <div class="sprite-grid" id="groundGrid"></div>
    </div>

    <div class="section">
        <h2>Buildings & Structures</h2>
        <div class="sprite-grid" id="buildingGrid"></div>
    </div>

    <div class="section">
        <h2>All Angles (8 directions)</h2>
        <div id="angleStrips"></div>
    </div>

    <script>
        // Canvas context for drawing
        let ctx;
        
        // Global settings
        let settings = {
            size: 48,
            heading: 0,
            camAngle: 0,
            fogFactor: 0,
            ambient: 1.0,
            baseColor: '#4a5a4a',
            bgColor: '#2a2a4e',
            skyColor: 0xFFD4A088
        };

        // Camera object (simulated)
        const camera = { angle: 0 };

        // ============== UTILITY FUNCTIONS ==============
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = Math.max(0, Math.min(255, Math.round(x))).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function darkenColor(hex, percent) {
            const rgb = hexToRgb(hex);
            const factor = 1 - percent / 100;
            return rgbToHex(rgb.r * factor, rgb.g * factor, rgb.b * factor);
        }

        function lightenColor(hex, percent) {
            const rgb = hexToRgb(hex);
            const factor = percent / 100;
            return rgbToHex(
                rgb.r + (255 - rgb.r) * factor,
                rgb.g + (255 - rgb.g) * factor,
                rgb.b + (255 - rgb.b) * factor
            );
        }

        function normalizeAngle(angle) {
            while (angle < 0) angle += Math.PI * 2;
            while (angle >= Math.PI * 2) angle -= Math.PI * 2;
            return angle;
        }

        function applyAmbientToHex(hex, ambient) {
            const rgb = hexToRgb(hex);
            return {
                r: Math.round(rgb.r * ambient),
                g: Math.round(rgb.g * ambient),
                b: Math.round(rgb.b * ambient)
            };
        }

        function rgbToCss(rgb) {
            return `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
        }

        function blendColorWithFog(rgb, fogFactor, skyColor) {
            const skyRgb = {
                r: (skyColor >> 16) & 0xFF,
                g: (skyColor >> 8) & 0xFF,
                b: skyColor & 0xFF
            };
            return {
                r: Math.round(rgb.r * (1 - fogFactor) + skyRgb.r * fogFactor),
                g: Math.round(rgb.g * (1 - fogFactor) + skyRgb.g * fogFactor),
                b: Math.round(rgb.b * (1 - fogFactor) + skyRgb.b * fogFactor)
            };
        }

        function getSpriteColorWithFog(baseColor, fogFactor, ambient, skyColor) {
            let color = applyAmbientToHex(baseColor, ambient);
            if (fogFactor > 0) {
                color = blendColorWithFog(color, fogFactor, skyColor);
            }
            return rgbToCss(color);
        }

        // ============== SPRITE DRAWING FUNCTIONS ==============

        function drawSoldier(ctx, x, y, size, color, pose = 'stand', fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 8);
            const ix = Math.floor(x);
            const iy = Math.floor(y);
            
            // Proportions - more realistic military figure
            const headW = Math.max(2, Math.floor(s * 0.18));
            const headH = Math.max(2, Math.floor(s * 0.16));
            const helmetH = Math.max(1, Math.floor(s * 0.06));
            const torsoW = Math.max(3, Math.floor(s * 0.26));
            const torsoH = Math.max(4, Math.floor(s * 0.32));
            const legW = Math.max(2, Math.floor(s * 0.1));
            const legH = Math.max(3, Math.floor(s * 0.28));
            const armW = Math.max(1, Math.floor(s * 0.08));
            const armH = Math.max(2, Math.floor(s * 0.22));
            const bootH = Math.max(1, Math.floor(s * 0.06));
            const packW = Math.max(2, Math.floor(s * 0.14));
            const packH = Math.max(2, Math.floor(s * 0.18));

            // Colors with proper shading
            const base = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 20), fogFactor, ambient, skyColor);
            const darker = getSpriteColorWithFog(darkenColor(color, 35), fogFactor, ambient, skyColor);
            const highlight = getSpriteColorWithFog(lightenColor(color, 10), fogFactor, ambient, skyColor);
            const skin = getSpriteColorWithFog('#8a6a5a', fogFactor, ambient, skyColor);
            const gear = getSpriteColorWithFog('#2a2a2a', fogFactor, ambient, skyColor);
            const gearDark = getSpriteColorWithFog('#1a1a1a', fogFactor, ambient, skyColor);
            const boot = getSpriteColorWithFog('#3a3020', fogFactor, ambient, skyColor);

            // Adjust positions based on pose
            const isCrouch = pose === 'crouch';
            const isShoot = pose === 'shoot';
            const crouchOffset = isCrouch ? Math.floor(s * 0.12) : 0;
            const legSpread = isCrouch ? Math.floor(s * 0.04) : Math.floor(s * 0.02);

            // Y positions (bottom-up construction)
            const bootY = iy - bootH + crouchOffset;
            const legY = bootY - legH + (isCrouch ? Math.floor(legH * 0.3) : 0);
            const torsoY = legY - torsoH + Math.floor(s * 0.04);
            const headY = torsoY - headH - helmetH + Math.floor(s * 0.02);
            const armY = torsoY + Math.floor(s * 0.02);

            // Boots
            ctx.fillStyle = boot;
            ctx.fillRect(ix - legW - legSpread, bootY, legW + 1, bootH);
            ctx.fillRect(ix + legSpread - 1, bootY, legW + 1, bootH);

            // Legs
            ctx.fillStyle = dark;
            ctx.fillRect(ix - legW - legSpread, legY, legW, legH);
            ctx.fillRect(ix + legSpread, legY, legW, legH);
            // Leg highlight
            ctx.fillStyle = base;
            ctx.fillRect(ix - legW - legSpread, legY, Math.max(1, Math.floor(legW * 0.4)), legH);

            // Torso
            ctx.fillStyle = base;
            ctx.fillRect(ix - Math.floor(torsoW / 2), torsoY, torsoW, torsoH);
            // Torso shadow (left side)
            ctx.fillStyle = dark;
            ctx.fillRect(ix - Math.floor(torsoW / 2), torsoY, Math.max(1, Math.floor(torsoW * 0.25)), torsoH);
            // Torso highlight (right side)
            ctx.fillStyle = highlight;
            ctx.fillRect(ix + Math.floor(torsoW / 2) - 1, torsoY, 1, torsoH);

            // Backpack/gear
            ctx.fillStyle = darker;
            ctx.fillRect(ix - Math.floor(torsoW / 2) - packW + 1, torsoY + Math.floor(s * 0.04), packW, packH);
            ctx.fillStyle = gearDark;
            ctx.fillRect(ix - Math.floor(torsoW / 2) - packW + 1, torsoY + Math.floor(s * 0.04), Math.max(1, Math.floor(packW * 0.3)), packH);

            // Arms
            const armOffsetY = isShoot ? -Math.floor(s * 0.06) : 0;
            ctx.fillStyle = dark;
            ctx.fillRect(ix - Math.floor(torsoW / 2) - armW, armY + armOffsetY, armW, armH);
            ctx.fillRect(ix + Math.floor(torsoW / 2), armY + armOffsetY, armW, armH);

            // Helmet
            ctx.fillStyle = darker;
            ctx.fillRect(ix - Math.floor(headW / 2) - 1, headY, headW + 2, helmetH + 1);
            // Helmet rim
            ctx.fillStyle = gearDark;
            ctx.fillRect(ix - Math.floor(headW / 2) - 1, headY + helmetH, headW + 2, 1);

            // Head/face
            ctx.fillStyle = skin;
            ctx.fillRect(ix - Math.floor(headW / 2), headY + helmetH, headW, headH);

            // Weapon (rifle shape)
            const weaponLen = Math.max(3, Math.floor(s * 0.4));
            const weaponH = Math.max(1, Math.floor(s * 0.05));
            const stockLen = Math.max(2, Math.floor(s * 0.12));
            const magH = Math.max(1, Math.floor(s * 0.08));
            
            if (isShoot) {
                // Weapon raised, pointing forward
                const weaponX = ix + Math.floor(torsoW / 2) + armW - 1;
                const weaponY = armY + armOffsetY + Math.floor(armH * 0.3);
                ctx.fillStyle = gear;
                ctx.fillRect(weaponX, weaponY, weaponLen, weaponH);
                // Stock
                ctx.fillStyle = gearDark;
                ctx.fillRect(weaponX - stockLen, weaponY - 1, stockLen, weaponH + 2);
                // Magazine
                ctx.fillRect(weaponX + Math.floor(weaponLen * 0.3), weaponY + weaponH, Math.max(1, Math.floor(s * 0.04)), magH);
            } else {
                // Weapon at rest, angled down
                const weaponX = ix + Math.floor(torsoW / 2);
                const weaponY = armY + Math.floor(armH * 0.5);
                ctx.fillStyle = gear;
                ctx.fillRect(weaponX, weaponY, Math.floor(weaponLen * 0.7), weaponH);
                ctx.fillRect(weaponX + Math.floor(weaponLen * 0.2), weaponY + weaponH, weaponH, Math.floor(weaponLen * 0.4));
                // Stock
                ctx.fillStyle = gearDark;
                ctx.fillRect(weaponX - Math.floor(stockLen * 0.5), weaponY - 1, Math.floor(stockLen * 0.6), weaponH + 2);
            }
        }

        function drawHelicopter(ctx, x, y, size, color, heading, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 12);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            // Colors - military stealth helicopter palette
            const body = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 25), fogFactor, ambient, skyColor);
            const darker = getSpriteColorWithFog(darkenColor(color, 40), fogFactor, ambient, skyColor);
            const highlight = getSpriteColorWithFog(lightenColor(color, 12), fogFactor, ambient, skyColor);
            const glass = getSpriteColorWithFog('#1a4a5a', fogFactor, ambient, skyColor);
            const glassHighlight = getSpriteColorWithFog('#3a7a9a', fogFactor, ambient, skyColor);
            const rotor = getSpriteColorWithFog('#3a3a3a', fogFactor, ambient, skyColor);
            const exhaust = getSpriteColorWithFog('#2a2a2a', fogFactor, ambient, skyColor);

            const relAngle = normalizeAngle(heading - camera.angle);
            const sinRel = Math.sin(relAngle);
            const cosRel = Math.cos(relAngle);

            // Determine view type
            const showFront = sinRel > 0.7;   // ~45° to ~135° - nose toward camera
            const showBack = sinRel < -0.7;   // ~225° to ~315° - tail toward camera
            const showSide = !showFront && !showBack;  // Side profile
            const facingRight = cosRel >= 0;  // For side view mirroring
            const dir = facingRight ? 1 : -1;

            if (showFront) {
                // FRONT VIEW - Apache-style attack helicopter facing camera
                ctx.save();
                ctx.translate(ix, iy);

                const fuseW = s * 0.28;  // Narrow fuselage (attack helicopters are slim)
                const fuseH = s * 0.55;  // Taller than wide from front
                const wingSpan = s * 0.9;  // Stub wings extend wide
                const rotorRadX = s * 0.75;
                const rotorRadY = s * 0.2;

                // Rotor disc (top-down perspective ellipse above)
                const rotorTime = performance.now() / 40;
                ctx.fillStyle = rotor;
                ctx.globalAlpha = 0.2;
                ctx.beginPath();
                ctx.ellipse(0, -fuseH * 0.9, rotorRadX, rotorRadY, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Rotor blades
                ctx.globalAlpha = 0.6;
                for (let i = 0; i < 4; i++) {
                    const angle = rotorTime + (i * Math.PI / 2);
                    const bx = Math.cos(angle) * rotorRadX;
                    const by = Math.sin(angle) * rotorRadY;
                    const bladeW = Math.max(2, Math.floor(s * 0.05));
                    ctx.fillRect(bx - bladeW / 2, -fuseH * 0.9 + by - 1, bladeW, 2);
                }
                ctx.globalAlpha = 1.0;

                // Rotor mast
                ctx.fillStyle = darker;
                ctx.fillRect(-s * 0.03, -fuseH * 0.75, s * 0.06, s * 0.18);
                
                // Mast-mounted sensor dome (Comanche/EVE style)
                ctx.fillStyle = getSpriteColorWithFog('#2a3a3a', fogFactor, ambient, skyColor);
                ctx.beginPath();
                ctx.arc(0, -fuseH * 1.0, s * 0.08, 0, Math.PI * 2);
                ctx.fill();
                // Sensor lens
                ctx.fillStyle = getSpriteColorWithFog('#1a2a2a', fogFactor, ambient, skyColor);
                ctx.beginPath();
                ctx.arc(0, -fuseH * 0.98, s * 0.04, Math.PI * 0.8, Math.PI * 2.2);
                ctx.fill();

                // Engine housings (on top sides of fuselage)
                ctx.fillStyle = dark;
                ctx.fillRect(-fuseW - s * 0.12, -fuseH * 0.45, s * 0.14, s * 0.22);
                ctx.fillRect(fuseW - s * 0.02, -fuseH * 0.45, s * 0.14, s * 0.22);

                // Main fuselage body (narrow, angular)
                ctx.fillStyle = body;
                ctx.beginPath();
                ctx.moveTo(-fuseW, -fuseH * 0.5);
                ctx.lineTo(fuseW, -fuseH * 0.5);
                ctx.lineTo(fuseW * 1.1, fuseH * 0.1);
                ctx.lineTo(fuseW * 0.7, fuseH * 0.5);
                ctx.lineTo(-fuseW * 0.7, fuseH * 0.5);
                ctx.lineTo(-fuseW * 1.1, fuseH * 0.1);
                ctx.closePath();
                ctx.fill();

                // Fuselage center line (angular detail)
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.moveTo(0, -fuseH * 0.5);
                ctx.lineTo(s * 0.03, fuseH * 0.3);
                ctx.lineTo(-s * 0.03, fuseH * 0.3);
                ctx.closePath();
                ctx.fill();

                // Cockpit canopy (tandem seating)
                ctx.fillStyle = glass;
                ctx.beginPath();
                ctx.moveTo(-fuseW * 0.5, -fuseH * 0.35);
                ctx.lineTo(fuseW * 0.5, -fuseH * 0.35);
                ctx.lineTo(fuseW * 0.4, fuseH * 0.15);
                ctx.lineTo(-fuseW * 0.4, fuseH * 0.15);
                ctx.closePath();
                ctx.fill();

                // Canopy frame
                ctx.fillStyle = darker;
                ctx.fillRect(-fuseW * 0.45, -fuseH * 0.12, fuseW * 0.9, s * 0.02);

                // Glass highlight
                ctx.fillStyle = glassHighlight;
                ctx.beginPath();
                ctx.moveTo(-fuseW * 0.35, -fuseH * 0.3);
                ctx.lineTo(0, -fuseH * 0.3);
                ctx.lineTo(-fuseW * 0.1, -fuseH * 0.15);
                ctx.lineTo(-fuseW * 0.35, -fuseH * 0.15);
                ctx.closePath();
                ctx.fill();

                // Stub wings with weapon pylons
                ctx.fillStyle = dark;
                ctx.fillRect(-wingSpan * 0.5, -fuseH * 0.05, wingSpan * 0.35, s * 0.08);
                ctx.fillRect(fuseW + s * 0.02, -fuseH * 0.05, wingSpan * 0.35, s * 0.08);

                // Weapons on pylons
                ctx.fillStyle = darker;
                ctx.fillRect(-wingSpan * 0.45, s * 0.02, s * 0.06, s * 0.15);
                ctx.fillRect(-wingSpan * 0.32, s * 0.02, s * 0.06, s * 0.15);
                ctx.fillRect(wingSpan * 0.26, s * 0.02, s * 0.06, s * 0.15);
                ctx.fillRect(wingSpan * 0.39, s * 0.02, s * 0.06, s * 0.15);

                // Chin turret
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.moveTo(-s * 0.08, fuseH * 0.35);
                ctx.lineTo(s * 0.08, fuseH * 0.35);
                ctx.lineTo(s * 0.05, fuseH * 0.55);
                ctx.lineTo(-s * 0.05, fuseH * 0.55);
                ctx.closePath();
                ctx.fill();

                // Gun barrel
                ctx.fillStyle = exhaust;
                ctx.fillRect(-s * 0.02, fuseH * 0.5, s * 0.04, s * 0.12);

                // Landing gear
                ctx.fillStyle = darker;
                ctx.fillRect(-fuseW - s * 0.04, fuseH * 0.3, s * 0.04, s * 0.18);
                ctx.fillRect(-fuseW - s * 0.08, fuseH * 0.45, s * 0.1, s * 0.03);
                ctx.fillRect(fuseW, fuseH * 0.3, s * 0.04, s * 0.18);
                ctx.fillRect(fuseW - s * 0.02, fuseH * 0.45, s * 0.1, s * 0.03);

                ctx.restore();
                return;
            }

            if (showBack) {
                // BACK VIEW - tail/exhausts facing camera
                ctx.save();
                ctx.translate(ix, iy);

                const fuseW = s * 0.28;
                const fuseH = s * 0.55;
                const wingSpan = s * 0.9;
                const rotorRadX = s * 0.75;
                const rotorRadY = s * 0.2;

                // Rotor disc
                const rotorTime = performance.now() / 40;
                ctx.fillStyle = rotor;
                ctx.globalAlpha = 0.2;
                ctx.beginPath();
                ctx.ellipse(0, -fuseH * 0.9, rotorRadX, rotorRadY, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Rotor blades
                ctx.globalAlpha = 0.6;
                for (let i = 0; i < 4; i++) {
                    const angle = rotorTime + (i * Math.PI / 2);
                    const bx = Math.cos(angle) * rotorRadX;
                    const by = Math.sin(angle) * rotorRadY;
                    const bladeW = Math.max(2, Math.floor(s * 0.05));
                    ctx.fillRect(bx - bladeW / 2, -fuseH * 0.9 + by - 1, bladeW, 2);
                }
                ctx.globalAlpha = 1.0;

                // Rotor mast
                ctx.fillStyle = darker;
                ctx.fillRect(-s * 0.03, -fuseH * 0.75, s * 0.06, s * 0.18);

                // Engine housings with exhausts
                ctx.fillStyle = dark;
                ctx.fillRect(-fuseW - s * 0.12, -fuseH * 0.45, s * 0.14, s * 0.22);
                ctx.fillRect(fuseW - s * 0.02, -fuseH * 0.45, s * 0.14, s * 0.22);
                
                // Engine exhausts
                ctx.fillStyle = exhaust;
                ctx.fillRect(-fuseW - s * 0.1, -fuseH * 0.35, s * 0.1, s * 0.12);
                ctx.fillRect(fuseW, -fuseH * 0.35, s * 0.1, s * 0.12);
                // Exhaust glow
                ctx.fillStyle = getSpriteColorWithFog('#5a4a3a', fogFactor, ambient, skyColor);
                ctx.fillRect(-fuseW - s * 0.08, -fuseH * 0.32, s * 0.06, s * 0.06);
                ctx.fillRect(fuseW + s * 0.02, -fuseH * 0.32, s * 0.06, s * 0.06);

                // Main fuselage body (rear view)
                ctx.fillStyle = body;
                ctx.beginPath();
                ctx.moveTo(-fuseW, -fuseH * 0.5);
                ctx.lineTo(fuseW, -fuseH * 0.5);
                ctx.lineTo(fuseW * 1.1, fuseH * 0.1);
                ctx.lineTo(fuseW * 0.7, fuseH * 0.5);
                ctx.lineTo(-fuseW * 0.7, fuseH * 0.5);
                ctx.lineTo(-fuseW * 1.1, fuseH * 0.1);
                ctx.closePath();
                ctx.fill();

                // Fuselage rear panel detail
                ctx.fillStyle = darker;
                ctx.fillRect(-fuseW * 0.6, -fuseH * 0.4, fuseW * 1.2, s * 0.04);
                ctx.fillRect(-fuseW * 0.5, fuseH * 0.1, fuseW * 1.0, s * 0.03);

                // Stub wings (from behind)
                ctx.fillStyle = dark;
                ctx.fillRect(-wingSpan * 0.5, -fuseH * 0.05, wingSpan * 0.35, s * 0.08);
                ctx.fillRect(fuseW + s * 0.02, -fuseH * 0.05, wingSpan * 0.35, s * 0.08);

                // Weapons on pylons (rear view)
                ctx.fillStyle = darker;
                ctx.fillRect(-wingSpan * 0.45, s * 0.02, s * 0.06, s * 0.15);
                ctx.fillRect(-wingSpan * 0.32, s * 0.02, s * 0.06, s * 0.15);
                ctx.fillRect(wingSpan * 0.26, s * 0.02, s * 0.06, s * 0.15);
                ctx.fillRect(wingSpan * 0.39, s * 0.02, s * 0.06, s * 0.15);

                // Tail boom (foreshortened)
                ctx.fillStyle = dark;
                ctx.fillRect(-s * 0.05, fuseH * 0.35, s * 0.1, s * 0.35);

                // Tail fin with fenestron
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.moveTo(0, fuseH * 0.5);
                ctx.lineTo(-s * 0.12, fuseH * 0.85);
                ctx.lineTo(s * 0.12, fuseH * 0.85);
                ctx.closePath();
                ctx.fill();
                
                // Horizontal stabilizer
                ctx.fillStyle = dark;
                ctx.fillRect(-s * 0.28, fuseH * 0.68, s * 0.56, s * 0.05);

                // Fenestron (enclosed tail rotor) - seen from behind
                const fenRadBack = s * 0.11;
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.arc(0, fuseH * 0.72, fenRadBack * 1.15, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = body;
                ctx.beginPath();
                ctx.arc(0, fuseH * 0.72, fenRadBack * 0.8, 0, Math.PI * 2);
                ctx.fill();
                // Animated fan blades
                const fenTimeBack = performance.now() / 20;
                ctx.strokeStyle = rotor;
                ctx.lineWidth = Math.max(1, s * 0.015);
                for (let i = 0; i < 8; i++) {
                    const fAngle = fenTimeBack + (i * Math.PI / 4);
                    ctx.beginPath();
                    ctx.moveTo(0, fuseH * 0.72);
                    ctx.lineTo(
                        Math.cos(fAngle) * fenRadBack * 0.7,
                        fuseH * 0.72 + Math.sin(fAngle) * fenRadBack * 0.7
                    );
                    ctx.stroke();
                }
                ctx.lineWidth = 1;
                // Center hub
                ctx.fillStyle = exhaust;
                ctx.beginPath();
                ctx.arc(0, fuseH * 0.72, fenRadBack * 0.18, 0, Math.PI * 2);
                ctx.fill();

                // Landing skids
                ctx.fillStyle = darker;
                ctx.fillRect(-fuseW - s * 0.08, fuseH * 0.1, s * 0.06, s * 0.4);
                ctx.fillRect(-fuseW - s * 0.12, fuseH * 0.45, s * 0.14, s * 0.04);
                ctx.fillRect(fuseW + s * 0.02, fuseH * 0.1, s * 0.06, s * 0.4);
                ctx.fillRect(fuseW - s * 0.02, fuseH * 0.45, s * 0.14, s * 0.04);

                ctx.restore();
                return;
            }

            // SIDE VIEW (with fenestron)
            ctx.save();
            ctx.translate(ix, iy);
            ctx.scale(dir, 1);

            // Proportions - sleek Comanche/Apache-like profile
            const fuseLen = s * 1.4;
            const fuseH = s * 0.28;
            const noseLen = s * 0.35;
            const tailLen = s * 0.9;
            const tailH = s * 0.1;
            const finH = s * 0.22;
            const skidH = Math.max(1, Math.floor(s * 0.04));
            const skidStrut = Math.max(1, Math.floor(s * 0.03));

            // Tail boom (tapered)
            ctx.fillStyle = dark;
            ctx.beginPath();
            ctx.moveTo(-fuseLen * 0.35, -tailH * 0.6);
            ctx.lineTo(-fuseLen * 0.35 - tailLen, -tailH * 0.3);
            ctx.lineTo(-fuseLen * 0.35 - tailLen, tailH * 0.3);
            ctx.lineTo(-fuseLen * 0.35, tailH * 0.6);
            ctx.closePath();
            ctx.fill();

            // Tail fin (vertical stabilizer)
            ctx.fillStyle = darker;
            ctx.beginPath();
            ctx.moveTo(-fuseLen * 0.35 - tailLen + s * 0.08, -tailH * 0.3);
            ctx.lineTo(-fuseLen * 0.35 - tailLen - s * 0.04, -finH);
            ctx.lineTo(-fuseLen * 0.35 - tailLen - s * 0.12, -finH);
            ctx.lineTo(-fuseLen * 0.35 - tailLen - s * 0.06, -tailH * 0.3);
            ctx.closePath();
            ctx.fill();

            // Horizontal stabilizer
            ctx.fillStyle = dark;
            ctx.fillRect(-fuseLen * 0.35 - tailLen - s * 0.02, -s * 0.02, s * 0.18, s * 0.04);

            // Fenestron (enclosed tail rotor) - Comanche/EVE style
            const fenestronRadius = s * 0.1;
            const fenestronX = -fuseLen * 0.35 - tailLen - s * 0.03;
            const fenestronY = -finH + s * 0.08;
            
            // Fenestron shroud (circular enclosure)
            ctx.fillStyle = darker;
            ctx.beginPath();
            ctx.arc(fenestronX, fenestronY, fenestronRadius * 1.2, 0, Math.PI * 2);
            ctx.fill();
            
            // Inner spinning fan
            ctx.fillStyle = body;
            ctx.beginPath();
            ctx.arc(fenestronX, fenestronY, fenestronRadius * 0.85, 0, Math.PI * 2);
            ctx.fill();
            
            // Fan blade hints (animated)
            const fenTime = performance.now() / 20;
            ctx.strokeStyle = rotor;
            ctx.lineWidth = Math.max(1, s * 0.02);
            for (let i = 0; i < 8; i++) {
                const fAngle = fenTime + (i * Math.PI / 4);
                ctx.beginPath();
                ctx.moveTo(fenestronX, fenestronY);
                ctx.lineTo(
                    fenestronX + Math.cos(fAngle) * fenestronRadius * 0.75,
                    fenestronY + Math.sin(fAngle) * fenestronRadius * 0.75
                );
                ctx.stroke();
            }
            ctx.lineWidth = 1;
            
            // Fenestron center hub
            ctx.fillStyle = exhaust;
            ctx.beginPath();
            ctx.arc(fenestronX, fenestronY, fenestronRadius * 0.2, 0, Math.PI * 2);
            ctx.fill();

            // Main fuselage (angular stealth shape)
            ctx.fillStyle = body;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.4, -fuseH * 0.2);  // Nose top
            ctx.lineTo(fuseLen * 0.5, fuseH * 0.1);   // Nose tip
            ctx.lineTo(fuseLen * 0.4, fuseH * 0.4);   // Nose bottom
            ctx.lineTo(-fuseLen * 0.35, fuseH * 0.5); // Rear bottom
            ctx.lineTo(-fuseLen * 0.35, -fuseH * 0.4);// Rear top
            ctx.lineTo(fuseLen * 0.15, -fuseH * 0.5); // Top spine
            ctx.closePath();
            ctx.fill();

            // Fuselage top highlight
            ctx.fillStyle = highlight;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.35, -fuseH * 0.25);
            ctx.lineTo(fuseLen * 0.15, -fuseH * 0.5);
            ctx.lineTo(-fuseLen * 0.25, -fuseH * 0.4);
            ctx.lineTo(-fuseLen * 0.1, -fuseH * 0.25);
            ctx.closePath();
            ctx.fill();

            // Fuselage bottom shadow
            ctx.fillStyle = dark;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.4, fuseH * 0.35);
            ctx.lineTo(-fuseLen * 0.35, fuseH * 0.5);
            ctx.lineTo(-fuseLen * 0.35, fuseH * 0.3);
            ctx.lineTo(fuseLen * 0.35, fuseH * 0.2);
            ctx.closePath();
            ctx.fill();

            // Engine intake (top)
            ctx.fillStyle = darker;
            ctx.fillRect(-fuseLen * 0.15, -fuseH * 0.55, s * 0.2, s * 0.08);

            // Engine exhaust (rear sides)
            ctx.fillStyle = exhaust;
            ctx.fillRect(-fuseLen * 0.38, -fuseH * 0.2, s * 0.08, s * 0.12);
            ctx.fillRect(-fuseLen * 0.38, fuseH * 0.1, s * 0.08, s * 0.12);

            // Cockpit glass (angular, multi-pane)
            ctx.fillStyle = glass;
            // Main canopy
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.38, -fuseH * 0.15);
            ctx.lineTo(fuseLen * 0.48, fuseH * 0.05);
            ctx.lineTo(fuseLen * 0.35, fuseH * 0.25);
            ctx.lineTo(fuseLen * 0.1, fuseH * 0.2);
            ctx.lineTo(fuseLen * 0.08, -fuseH * 0.2);
            ctx.closePath();
            ctx.fill();
            // Glass highlight
            ctx.fillStyle = glassHighlight;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.36, -fuseH * 0.1);
            ctx.lineTo(fuseLen * 0.42, fuseH * 0.0);
            ctx.lineTo(fuseLen * 0.3, fuseH * 0.05);
            ctx.lineTo(fuseLen * 0.28, -fuseH * 0.1);
            ctx.closePath();
            ctx.fill();

            // Chin sensor/gun turret
            ctx.fillStyle = darker;
            ctx.beginPath();
            ctx.arc(fuseLen * 0.35, fuseH * 0.35, s * 0.08, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = exhaust;
            ctx.fillRect(fuseLen * 0.35, fuseH * 0.32, s * 0.15, s * 0.04);

            // Landing skids
            ctx.fillStyle = darker;
            // Skid struts
            ctx.fillRect(fuseLen * 0.15, fuseH * 0.4, skidStrut, s * 0.18);
            ctx.fillRect(-fuseLen * 0.15, fuseH * 0.4, skidStrut, s * 0.18);
            // Skid rails
            ctx.fillRect(-fuseLen * 0.22, fuseH * 0.55, fuseLen * 0.5, skidH);

            // Main rotor disc (perspective ellipse)
            const rotorTime = performance.now() / 40;
            const rotorRadX = fuseLen * 0.7;
            const rotorRadY = fuseLen * 0.2;
            
            // Rotor blur disc
            ctx.fillStyle = rotor;
            ctx.globalAlpha = 0.25;
            ctx.beginPath();
            ctx.ellipse(0, -fuseH * 0.7, rotorRadX, rotorRadY, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Rotor blades (4 blades)
            ctx.globalAlpha = 0.7;
            for (let i = 0; i < 4; i++) {
                const angle = rotorTime + (i * Math.PI / 2);
                const bx = Math.cos(angle) * rotorRadX;
                const by = Math.sin(angle) * rotorRadY;
                const bladeW = Math.max(2, Math.floor(s * 0.06));
                ctx.fillRect(bx - bladeW / 2, -fuseH * 0.7 + by - 1, bladeW, 2);
            }
            ctx.globalAlpha = 1.0;

            // Rotor hub/mast
            ctx.fillStyle = darker;
            ctx.fillRect(-s * 0.04, -fuseH * 0.8, s * 0.08, s * 0.12);
            ctx.fillStyle = exhaust;
            ctx.beginPath();
            ctx.arc(0, -fuseH * 0.82, s * 0.05, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }
            ctx.globalAlpha = 1.0;

            // Rotor hub/mast
            ctx.fillStyle = darker;
            ctx.fillRect(-s * 0.04, -fuseH * 0.8, s * 0.08, s * 0.12);
            ctx.fillStyle = exhaust;
            ctx.beginPath();
            ctx.arc(0, -fuseH * 0.82, s * 0.05, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        function drawAttackHelicopter(ctx, x, y, size, color, heading, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 14);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            // Colors - aggressive attack helicopter palette (slightly different from player)
            const body = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 22), fogFactor, ambient, skyColor);
            const darker = getSpriteColorWithFog(darkenColor(color, 38), fogFactor, ambient, skyColor);
            const highlight = getSpriteColorWithFog(lightenColor(color, 10), fogFactor, ambient, skyColor);
            const glass = getSpriteColorWithFog('#1a3a3a', fogFactor, ambient, skyColor);
            const glassHighlight = getSpriteColorWithFog('#3a6a6a', fogFactor, ambient, skyColor);
            const rotor = getSpriteColorWithFog('#3a3a3a', fogFactor, ambient, skyColor);
            const weapon = getSpriteColorWithFog('#2a2a2a', fogFactor, ambient, skyColor);
            const weaponDark = getSpriteColorWithFog('#1a1a1a', fogFactor, ambient, skyColor);

            const relAngle = normalizeAngle(heading - camera.angle);
            const facingRight = Math.cos(relAngle) >= 0;
            const dir = facingRight ? 1 : -1;

            ctx.save();
            ctx.translate(ix, iy);
            ctx.scale(dir, 1);

            // Proportions - Apache/Hind-like aggressive profile
            const fuseLen = s * 1.5;
            const fuseH = s * 0.32;
            const tailLen = s * 0.95;
            const tailH = s * 0.12;
            const finH = s * 0.28;
            const wingSpan = s * 0.45;
            const skidH = Math.max(1, Math.floor(s * 0.04));

            // Tail boom (tapered, slightly thicker than player heli)
            ctx.fillStyle = dark;
            ctx.beginPath();
            ctx.moveTo(-fuseLen * 0.32, -tailH * 0.7);
            ctx.lineTo(-fuseLen * 0.32 - tailLen, -tailH * 0.35);
            ctx.lineTo(-fuseLen * 0.32 - tailLen, tailH * 0.35);
            ctx.lineTo(-fuseLen * 0.32, tailH * 0.7);
            ctx.closePath();
            ctx.fill();

            // Tail fin (larger, more aggressive)
            ctx.fillStyle = darker;
            ctx.beginPath();
            ctx.moveTo(-fuseLen * 0.32 - tailLen + s * 0.1, -tailH * 0.35);
            ctx.lineTo(-fuseLen * 0.32 - tailLen - s * 0.02, -finH);
            ctx.lineTo(-fuseLen * 0.32 - tailLen - s * 0.14, -finH);
            ctx.lineTo(-fuseLen * 0.32 - tailLen - s * 0.08, -tailH * 0.35);
            ctx.closePath();
            ctx.fill();

            // Horizontal stabilizer (larger)
            ctx.fillStyle = dark;
            ctx.fillRect(-fuseLen * 0.32 - tailLen - s * 0.04, -s * 0.03, s * 0.22, s * 0.06);

            // Tail rotor housing
            ctx.fillStyle = darker;
            ctx.fillRect(-fuseLen * 0.32 - tailLen - s * 0.1, -finH + s * 0.03, s * 0.12, s * 0.1);

            // Main fuselage (bulkier, more armored look)
            ctx.fillStyle = body;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.42, -fuseH * 0.1);  // Nose top
            ctx.lineTo(fuseLen * 0.5, fuseH * 0.2);    // Nose tip (lower, more aggressive)
            ctx.lineTo(fuseLen * 0.42, fuseH * 0.5);   // Nose bottom
            ctx.lineTo(-fuseLen * 0.32, fuseH * 0.55); // Rear bottom
            ctx.lineTo(-fuseLen * 0.32, -fuseH * 0.45);// Rear top
            ctx.lineTo(fuseLen * 0.1, -fuseH * 0.55);  // Top spine
            ctx.closePath();
            ctx.fill();

            // Fuselage top highlight
            ctx.fillStyle = highlight;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.35, -fuseH * 0.15);
            ctx.lineTo(fuseLen * 0.1, -fuseH * 0.52);
            ctx.lineTo(-fuseLen * 0.2, -fuseH * 0.42);
            ctx.lineTo(-fuseLen * 0.05, -fuseH * 0.2);
            ctx.closePath();
            ctx.fill();

            // Fuselage bottom shadow
            ctx.fillStyle = dark;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.4, fuseH * 0.4);
            ctx.lineTo(-fuseLen * 0.32, fuseH * 0.55);
            ctx.lineTo(-fuseLen * 0.32, fuseH * 0.35);
            ctx.lineTo(fuseLen * 0.35, fuseH * 0.25);
            ctx.closePath();
            ctx.fill();

            // Engine housing (bulge on top)
            ctx.fillStyle = darker;
            ctx.fillRect(-fuseLen * 0.2, -fuseH * 0.65, s * 0.28, s * 0.12);

            // Stub wings with weapon pylons
            ctx.fillStyle = body;
            // Upper wing
            ctx.beginPath();
            ctx.moveTo(-fuseLen * 0.05, -fuseH * 0.15);
            ctx.lineTo(-fuseLen * 0.05 - wingSpan, -fuseH * 0.25);
            ctx.lineTo(-fuseLen * 0.05 - wingSpan, -fuseH * 0.1);
            ctx.lineTo(-fuseLen * 0.15, -fuseH * 0.05);
            ctx.closePath();
            ctx.fill();
            // Lower wing
            ctx.beginPath();
            ctx.moveTo(-fuseLen * 0.05, fuseH * 0.2);
            ctx.lineTo(-fuseLen * 0.05 - wingSpan, fuseH * 0.3);
            ctx.lineTo(-fuseLen * 0.05 - wingSpan, fuseH * 0.15);
            ctx.lineTo(-fuseLen * 0.15, fuseH * 0.1);
            ctx.closePath();
            ctx.fill();

            // Weapon pylons
            ctx.fillStyle = weapon;
            // Rocket pods (upper wing)
            ctx.fillRect(-fuseLen * 0.05 - wingSpan * 0.7, -fuseH * 0.35, s * 0.18, s * 0.12);
            ctx.fillRect(-fuseLen * 0.05 - wingSpan * 0.4, -fuseH * 0.32, s * 0.14, s * 0.1);
            // Missile rails (lower wing)
            ctx.fillRect(-fuseLen * 0.05 - wingSpan * 0.7, fuseH * 0.28, s * 0.2, s * 0.08);
            ctx.fillRect(-fuseLen * 0.05 - wingSpan * 0.4, fuseH * 0.25, s * 0.16, s * 0.08);

            // Missiles on rails
            ctx.fillStyle = weaponDark;
            ctx.fillRect(-fuseLen * 0.05 - wingSpan * 0.65, fuseH * 0.36, s * 0.12, s * 0.04);
            ctx.fillRect(-fuseLen * 0.05 - wingSpan * 0.35, fuseH * 0.33, s * 0.1, s * 0.04);

            // Cockpit glass (tandem seating, angular)
            ctx.fillStyle = glass;
            // Front gunner
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.4, -fuseH * 0.05);
            ctx.lineTo(fuseLen * 0.48, fuseH * 0.15);
            ctx.lineTo(fuseLen * 0.35, fuseH * 0.35);
            ctx.lineTo(fuseLen * 0.2, fuseH * 0.3);
            ctx.lineTo(fuseLen * 0.18, -fuseH * 0.1);
            ctx.closePath();
            ctx.fill();
            // Rear pilot
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.15, -fuseH * 0.15);
            ctx.lineTo(fuseLen * 0.15, fuseH * 0.2);
            ctx.lineTo(-fuseLen * 0.02, fuseH * 0.15);
            ctx.lineTo(-fuseLen * 0.02, -fuseH * 0.25);
            ctx.closePath();
            ctx.fill();
            // Glass highlights
            ctx.fillStyle = glassHighlight;
            ctx.beginPath();
            ctx.moveTo(fuseLen * 0.38, 0);
            ctx.lineTo(fuseLen * 0.42, fuseH * 0.1);
            ctx.lineTo(fuseLen * 0.32, fuseH * 0.15);
            ctx.lineTo(fuseLen * 0.3, 0);
            ctx.closePath();
            ctx.fill();

            // Chin-mounted gun turret
            ctx.fillStyle = weapon;
            ctx.beginPath();
            ctx.arc(fuseLen * 0.38, fuseH * 0.45, s * 0.1, 0, Math.PI * 2);
            ctx.fill();
            // Gun barrel
            ctx.fillStyle = weaponDark;
            ctx.fillRect(fuseLen * 0.38, fuseH * 0.42, s * 0.22, s * 0.05);
            // Gun barrel tip
            ctx.fillRect(fuseLen * 0.58, fuseH * 0.4, s * 0.04, s * 0.08);

            // Landing gear (fixed skids)
            ctx.fillStyle = darker;
            // Skid struts
            ctx.fillRect(fuseLen * 0.12, fuseH * 0.45, Math.max(1, s * 0.03), s * 0.2);
            ctx.fillRect(-fuseLen * 0.18, fuseH * 0.45, Math.max(1, s * 0.03), s * 0.2);
            // Skid rails
            ctx.fillRect(-fuseLen * 0.25, fuseH * 0.62, fuseLen * 0.5, skidH);

            // Main rotor disc (perspective ellipse)
            const rotorTime = performance.now() / 38;
            const rotorRadX = fuseLen * 0.72;
            const rotorRadY = fuseLen * 0.22;
            
            // Rotor blur disc
            ctx.fillStyle = rotor;
            ctx.globalAlpha = 0.25;
            ctx.beginPath();
            ctx.ellipse(0, -fuseH * 0.75, rotorRadX, rotorRadY, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Rotor blades (4 blades)
            ctx.globalAlpha = 0.7;
            for (let i = 0; i < 4; i++) {
                const angle = rotorTime + (i * Math.PI / 2);
                const bx = Math.cos(angle) * rotorRadX;
                const by = Math.sin(angle) * rotorRadY;
                const bladeW = Math.max(2, Math.floor(s * 0.07));
                ctx.fillRect(bx - bladeW / 2, -fuseH * 0.75 + by - 1, bladeW, 2);
            }
            ctx.globalAlpha = 1.0;

            // Rotor hub/mast
            ctx.fillStyle = darker;
            ctx.fillRect(-s * 0.05, -fuseH * 0.88, s * 0.1, s * 0.15);
            ctx.fillStyle = weapon;
            ctx.beginPath();
            ctx.arc(0, -fuseH * 0.9, s * 0.06, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        function drawFighterJet(ctx, x, y, size, color, heading, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 12);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            // Colors - sleek fighter jet palette
            const body = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 25), fogFactor, ambient, skyColor);
            const darker = getSpriteColorWithFog(darkenColor(color, 40), fogFactor, ambient, skyColor);
            const highlight = getSpriteColorWithFog(lightenColor(color, 15), fogFactor, ambient, skyColor);
            const glass = getSpriteColorWithFog('#2a4a6a', fogFactor, ambient, skyColor);
            const glassHighlight = getSpriteColorWithFog('#4a7a9a', fogFactor, ambient, skyColor);
            const exhaust = getSpriteColorWithFog('#1a1a1a', fogFactor, ambient, skyColor);
            const exhaustGlow = getSpriteColorWithFog('#4a3a2a', fogFactor, ambient, skyColor);

            const relAngle = normalizeAngle(heading - camera.angle);
            const showSide = Math.abs(Math.sin(relAngle)) > 0.5;
            const facingRight = Math.cos(relAngle) >= 0;
            const dir = facingRight ? 1 : -1;

            if (showSide) {
                // Side view - F-16/F-22 like profile
                ctx.save();
                ctx.translate(ix, iy);
                ctx.scale(dir, 1);

                const fuseLen = s * 1.5;
                const fuseH = s * 0.22;
                const noseLen = s * 0.4;
                const wingChord = s * 0.35;

                // Main fuselage (sleek tapered shape)
                ctx.fillStyle = body;
                ctx.beginPath();
                ctx.moveTo(fuseLen * 0.5, 0);           // Nose tip
                ctx.lineTo(fuseLen * 0.35, -fuseH * 0.6); // Nose top
                ctx.lineTo(-fuseLen * 0.1, -fuseH * 0.8); // Canopy peak
                ctx.lineTo(-fuseLen * 0.5, -fuseH * 0.5); // Rear top
                ctx.lineTo(-fuseLen * 0.55, 0);          // Exhaust
                ctx.lineTo(-fuseLen * 0.5, fuseH * 0.5);  // Rear bottom
                ctx.lineTo(fuseLen * 0.3, fuseH * 0.5);   // Belly
                ctx.lineTo(fuseLen * 0.45, fuseH * 0.2);  // Nose bottom
                ctx.closePath();
                ctx.fill();

                // Fuselage top highlight
                ctx.fillStyle = highlight;
                ctx.beginPath();
                ctx.moveTo(fuseLen * 0.4, -fuseH * 0.4);
                ctx.lineTo(-fuseLen * 0.1, -fuseH * 0.75);
                ctx.lineTo(-fuseLen * 0.4, -fuseH * 0.5);
                ctx.lineTo(-fuseLen * 0.2, -fuseH * 0.4);
                ctx.closePath();
                ctx.fill();

                // Fuselage bottom shadow
                ctx.fillStyle = dark;
                ctx.beginPath();
                ctx.moveTo(fuseLen * 0.35, fuseH * 0.4);
                ctx.lineTo(-fuseLen * 0.45, fuseH * 0.5);
                ctx.lineTo(-fuseLen * 0.45, fuseH * 0.2);
                ctx.lineTo(fuseLen * 0.3, fuseH * 0.25);
                ctx.closePath();
                ctx.fill();

                // Wing (delta shape from side)
                ctx.fillStyle = dark;
                ctx.beginPath();
                ctx.moveTo(-fuseLen * 0.05, fuseH * 0.3);
                ctx.lineTo(-fuseLen * 0.35, fuseH * 0.9);
                ctx.lineTo(-fuseLen * 0.4, fuseH * 0.9);
                ctx.lineTo(-fuseLen * 0.35, fuseH * 0.3);
                ctx.closePath();
                ctx.fill();

                // Horizontal stabilizer
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.moveTo(-fuseLen * 0.4, fuseH * 0.2);
                ctx.lineTo(-fuseLen * 0.55, fuseH * 0.5);
                ctx.lineTo(-fuseLen * 0.55, fuseH * 0.35);
                ctx.lineTo(-fuseLen * 0.45, fuseH * 0.2);
                ctx.closePath();
                ctx.fill();

                // Vertical tail fin
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.moveTo(-fuseLen * 0.35, -fuseH * 0.5);
                ctx.lineTo(-fuseLen * 0.5, -fuseH * 1.3);
                ctx.lineTo(-fuseLen * 0.55, -fuseH * 1.3);
                ctx.lineTo(-fuseLen * 0.55, -fuseH * 0.5);
                ctx.closePath();
                ctx.fill();

                // Cockpit canopy
                ctx.fillStyle = glass;
                ctx.beginPath();
                ctx.moveTo(fuseLen * 0.3, -fuseH * 0.5);
                ctx.lineTo(-fuseLen * 0.1, -fuseH * 0.75);
                ctx.lineTo(-fuseLen * 0.15, -fuseH * 0.5);
                ctx.lineTo(fuseLen * 0.2, -fuseH * 0.35);
                ctx.closePath();
                ctx.fill();
                // Canopy frame
                ctx.fillStyle = darker;
                ctx.fillRect(fuseLen * 0.05, -fuseH * 0.65, s * 0.02, fuseH * 0.25);
                // Canopy highlight
                ctx.fillStyle = glassHighlight;
                ctx.beginPath();
                ctx.moveTo(fuseLen * 0.25, -fuseH * 0.45);
                ctx.lineTo(fuseLen * 0.1, -fuseH * 0.6);
                ctx.lineTo(fuseLen * 0.15, -fuseH * 0.45);
                ctx.closePath();
                ctx.fill();

                // Engine exhaust nozzle
                ctx.fillStyle = exhaust;
                ctx.fillRect(-fuseLen * 0.55, -fuseH * 0.3, s * 0.1, fuseH * 0.6);
                // Exhaust glow
                ctx.fillStyle = exhaustGlow;
                ctx.fillRect(-fuseLen * 0.58, -fuseH * 0.15, s * 0.05, fuseH * 0.3);

                // Air intake (under fuselage)
                ctx.fillStyle = darker;
                ctx.fillRect(fuseLen * 0.0, fuseH * 0.35, s * 0.2, s * 0.08);

                ctx.restore();
            } else {
                // Front/back view - delta wing silhouette
                const wingSpan = s * 1.1;
                const fuseH = s * 0.8;

                // Main delta wing shape
                ctx.fillStyle = body;
                ctx.beginPath();
                ctx.moveTo(ix, iy - fuseH * 0.5);           // Nose
                ctx.lineTo(ix - wingSpan, iy + fuseH * 0.15); // Left wing tip
                ctx.lineTo(ix - wingSpan * 0.3, iy + fuseH * 0.4); // Left wing root
                ctx.lineTo(ix, iy + fuseH * 0.5);           // Tail
                ctx.lineTo(ix + wingSpan * 0.3, iy + fuseH * 0.4); // Right wing root
                ctx.lineTo(ix + wingSpan, iy + fuseH * 0.15); // Right wing tip
                ctx.closePath();
                ctx.fill();

                // Wing top highlight
                ctx.fillStyle = highlight;
                ctx.beginPath();
                ctx.moveTo(ix, iy - fuseH * 0.4);
                ctx.lineTo(ix - wingSpan * 0.7, iy + fuseH * 0.05);
                ctx.lineTo(ix - wingSpan * 0.3, iy + fuseH * 0.1);
                ctx.lineTo(ix, iy - fuseH * 0.2);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(ix, iy - fuseH * 0.4);
                ctx.lineTo(ix + wingSpan * 0.7, iy + fuseH * 0.05);
                ctx.lineTo(ix + wingSpan * 0.3, iy + fuseH * 0.1);
                ctx.lineTo(ix, iy - fuseH * 0.2);
                ctx.closePath();
                ctx.fill();

                // Fuselage spine
                ctx.fillStyle = dark;
                ctx.fillRect(ix - s * 0.1, iy - fuseH * 0.35, s * 0.2, fuseH * 0.7);

                // Vertical tail fins (twin tails like F-22)
                ctx.fillStyle = darker;
                ctx.beginPath();
                ctx.moveTo(ix - s * 0.15, iy + fuseH * 0.2);
                ctx.lineTo(ix - s * 0.25, iy + fuseH * 0.5);
                ctx.lineTo(ix - s * 0.08, iy + fuseH * 0.45);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(ix + s * 0.15, iy + fuseH * 0.2);
                ctx.lineTo(ix + s * 0.25, iy + fuseH * 0.5);
                ctx.lineTo(ix + s * 0.08, iy + fuseH * 0.45);
                ctx.closePath();
                ctx.fill();

                // Cockpit canopy
                ctx.fillStyle = glass;
                ctx.fillRect(ix - s * 0.08, iy - fuseH * 0.3, s * 0.16, s * 0.18);
                ctx.fillStyle = glassHighlight;
                ctx.fillRect(ix - s * 0.06, iy - fuseH * 0.28, s * 0.06, s * 0.08);

                // Engine exhausts
                ctx.fillStyle = exhaust;
                ctx.beginPath();
                ctx.arc(ix - s * 0.08, iy + fuseH * 0.42, s * 0.06, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(ix + s * 0.08, iy + fuseH * 0.42, s * 0.06, 0, Math.PI * 2);
                ctx.fill();
                // Exhaust glow
                ctx.fillStyle = exhaustGlow;
                ctx.beginPath();
                ctx.arc(ix - s * 0.08, iy + fuseH * 0.44, s * 0.035, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(ix + s * 0.08, iy + fuseH * 0.44, s * 0.035, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawTransportPlane(ctx, x, y, size, color, heading, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 18);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            const body = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 20), fogFactor, ambient, skyColor);
            const windowColor = getSpriteColorWithFog('#4a6a8a', fogFactor, ambient, skyColor);

            const relAngle = normalizeAngle(heading - camera.angle);
            const showSide = Math.abs(Math.sin(relAngle)) > 0.5;
            const facingRight = Math.cos(relAngle) >= 0;
            const dir = facingRight ? 1 : -1;

            if (showSide) {
                ctx.save();
                ctx.translate(ix, iy);
                ctx.scale(dir, 1);

                // Large fuselage
                ctx.fillStyle = body;
                ctx.fillRect(-s * 0.95, -s * 0.22, s * 1.9, s * 0.44);

                // Nose
                ctx.beginPath();
                ctx.moveTo(s * 0.95, -s * 0.18);
                ctx.lineTo(s * 1.1, 0);
                ctx.lineTo(s * 0.95, s * 0.18);
                ctx.closePath();
                ctx.fill();

                // High wing
                ctx.fillStyle = dark;
                ctx.fillRect(-s * 0.2, -s * 0.38, s * 0.8, s * 0.12);

                // Tail + fin
                ctx.fillStyle = dark;
                ctx.fillRect(-s * 1.05, -s * 0.5, s * 0.2, s * 0.35);
                ctx.fillRect(-s * 1.05, -s * 0.35, s * 0.45, s * 0.12);

                // Windows
                ctx.fillStyle = windowColor;
                for (let i = 0; i < 5; i++) {
                    ctx.fillRect(-s * 0.5 + i * s * 0.22, -s * 0.12, s * 0.1, s * 0.08);
                }

                // Engines
                ctx.fillStyle = dark;
                ctx.fillRect(-s * 0.05, -s * 0.1, s * 0.16, s * 0.12);
                ctx.fillRect(s * 0.18, -s * 0.1, s * 0.16, s * 0.12);
                ctx.fillRect(s * 0.41, -s * 0.1, s * 0.16, s * 0.12);

                ctx.restore();
            } else {
                // Front/back view
                ctx.fillStyle = body;
                ctx.fillRect(ix - s * 0.25, iy - s * 0.55, s * 0.5, s * 1.1);

                // Wide high wings
                ctx.fillStyle = dark;
                ctx.fillRect(ix - s * 1.0, iy - s * 0.25, s * 2.0, s * 0.16);

                // Tail
                ctx.fillStyle = dark;
                ctx.fillRect(ix - s * 0.35, iy + s * 0.35, s * 0.7, s * 0.14);

                // Engines on wings
                ctx.fillRect(ix - s * 0.6, iy - s * 0.2, s * 0.16, s * 0.2);
                ctx.fillRect(ix - s * 0.2, iy - s * 0.2, s * 0.16, s * 0.2);
                ctx.fillRect(ix + s * 0.2, iy - s * 0.2, s * 0.16, s * 0.2);
                ctx.fillRect(ix + s * 0.6, iy - s * 0.2, s * 0.16, s * 0.2);

                // Cockpit windows
                ctx.fillStyle = windowColor;
                ctx.fillRect(ix - s * 0.1, iy - s * 0.35, s * 0.2, s * 0.12);
            }
        }

        function drawTank(ctx, x, y, size, color, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 14);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            // Colors - M1 Abrams-like military tank palette
            const base = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 18), fogFactor, ambient, skyColor);
            const darker = getSpriteColorWithFog(darkenColor(color, 32), fogFactor, ambient, skyColor);
            const highlight = getSpriteColorWithFog(lightenColor(color, 12), fogFactor, ambient, skyColor);
            const track = getSpriteColorWithFog('#1a1a1a', fogFactor, ambient, skyColor);
            const trackMid = getSpriteColorWithFog('#2a2a2a', fogFactor, ambient, skyColor);
            const trackHighlight = getSpriteColorWithFog('#3a3a3a', fogFactor, ambient, skyColor);
            const wheel = getSpriteColorWithFog('#252525', fogFactor, ambient, skyColor);
            const wheelHighlight = getSpriteColorWithFog('#404040', fogFactor, ambient, skyColor);
            const metal = getSpriteColorWithFog('#2a2a2a', fogFactor, ambient, skyColor);
            const metalDark = getSpriteColorWithFog('#1a1a1a', fogFactor, ambient, skyColor);

            // Dimensions - proper tank proportions
            const hullLen = s * 1.2;
            const hullH = s * 0.22;
            const trackH = Math.max(3, Math.floor(s * 0.24));
            const trackLen = s * 1.3;
            const turretLen = s * 0.55;
            const turretH = s * 0.2;
            const gunLen = s * 0.6;
            const gunH = Math.max(2, Math.floor(s * 0.06));
            const wheelRad = Math.max(2, Math.floor(trackH * 0.38));
            const wheelCount = Math.max(3, Math.floor(s / 12));

            // Y positions (bottom-up)
            const trackY = iy - Math.floor(trackH * 0.3);
            const hullY = trackY - hullH + Math.floor(trackH * 0.15);
            const turretY = hullY - turretH + Math.floor(s * 0.04);

            // Track assembly (with visible road wheels)
            // Track base
            ctx.fillStyle = track;
            ctx.fillRect(ix - trackLen * 0.5, trackY, trackLen, trackH);
            
            // Track top highlight
            ctx.fillStyle = trackHighlight;
            ctx.fillRect(ix - trackLen * 0.5, trackY, trackLen, Math.max(1, Math.floor(trackH * 0.15)));
            
            // Track guards/fenders
            ctx.fillStyle = dark;
            ctx.fillRect(ix - trackLen * 0.52, trackY - Math.floor(s * 0.04), trackLen * 1.04, Math.floor(s * 0.05));

            // Road wheels (visible between track sections)
            const wheelSpacing = trackLen / (wheelCount + 1);
            for (let i = 1; i <= wheelCount; i++) {
                const wx = ix - trackLen * 0.5 + wheelSpacing * i;
                const wy = trackY + trackH * 0.5;
                
                // Wheel body
                ctx.fillStyle = wheel;
                ctx.beginPath();
                ctx.arc(wx, wy, wheelRad, 0, Math.PI * 2);
                ctx.fill();
                
                // Wheel highlight (top)
                ctx.fillStyle = wheelHighlight;
                ctx.beginPath();
                ctx.arc(wx, wy - wheelRad * 0.3, wheelRad * 0.5, 0, Math.PI * 2);
                ctx.fill();
                
                // Wheel hub
                ctx.fillStyle = trackMid;
                ctx.beginPath();
                ctx.arc(wx, wy, wheelRad * 0.35, 0, Math.PI * 2);
                ctx.fill();
            }

            // Drive sprocket (rear)
            ctx.fillStyle = wheel;
            ctx.beginPath();
            ctx.arc(ix - trackLen * 0.42, trackY + trackH * 0.4, wheelRad * 0.9, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = wheelHighlight;
            ctx.beginPath();
            ctx.arc(ix - trackLen * 0.42, trackY + trackH * 0.3, wheelRad * 0.4, 0, Math.PI * 2);
            ctx.fill();

            // Idler wheel (front)
            ctx.fillStyle = wheel;
            ctx.beginPath();
            ctx.arc(ix + trackLen * 0.42, trackY + trackH * 0.4, wheelRad * 0.9, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = wheelHighlight;
            ctx.beginPath();
            ctx.arc(ix + trackLen * 0.42, trackY + trackH * 0.3, wheelRad * 0.4, 0, Math.PI * 2);
            ctx.fill();

            // Hull (sloped armor like M1 Abrams)
            ctx.fillStyle = base;
            ctx.beginPath();
            ctx.moveTo(ix + hullLen * 0.5, hullY + hullH);        // Front bottom
            ctx.lineTo(ix + hullLen * 0.55, hullY + hullH * 0.3); // Front slope
            ctx.lineTo(ix + hullLen * 0.4, hullY);                // Front top
            ctx.lineTo(ix - hullLen * 0.45, hullY);               // Rear top
            ctx.lineTo(ix - hullLen * 0.5, hullY + hullH);        // Rear bottom
            ctx.closePath();
            ctx.fill();

            // Hull top highlight
            ctx.fillStyle = highlight;
            ctx.beginPath();
            ctx.moveTo(ix + hullLen * 0.4, hullY);
            ctx.lineTo(ix - hullLen * 0.45, hullY);
            ctx.lineTo(ix - hullLen * 0.35, hullY + hullH * 0.25);
            ctx.lineTo(ix + hullLen * 0.3, hullY + hullH * 0.25);
            ctx.closePath();
            ctx.fill();

            // Hull side shadow
            ctx.fillStyle = dark;
            ctx.fillRect(ix - hullLen * 0.5, hullY + hullH * 0.6, hullLen, hullH * 0.4);

            // Turret (angular, modern design)
            ctx.fillStyle = base;
            ctx.beginPath();
            ctx.moveTo(ix + turretLen * 0.5, turretY + turretH);      // Front bottom
            ctx.lineTo(ix + turretLen * 0.55, turretY + turretH * 0.4);// Front slope
            ctx.lineTo(ix + turretLen * 0.4, turretY);                // Front top
            ctx.lineTo(ix - turretLen * 0.5, turretY);                // Rear top
            ctx.lineTo(ix - turretLen * 0.55, turretY + turretH);     // Rear bottom
            ctx.closePath();
            ctx.fill();

            // Turret top highlight
            ctx.fillStyle = highlight;
            ctx.beginPath();
            ctx.moveTo(ix + turretLen * 0.35, turretY);
            ctx.lineTo(ix - turretLen * 0.45, turretY);
            ctx.lineTo(ix - turretLen * 0.35, turretY + turretH * 0.3);
            ctx.lineTo(ix + turretLen * 0.25, turretY + turretH * 0.3);
            ctx.closePath();
            ctx.fill();

            // Turret side shadow
            ctx.fillStyle = dark;
            ctx.fillRect(ix - turretLen * 0.55, turretY + turretH * 0.65, turretLen * 1.1, turretH * 0.35);

            // Commander's hatch
            ctx.fillStyle = darker;
            ctx.fillRect(ix - turretLen * 0.15, turretY - Math.floor(s * 0.05), s * 0.15, Math.floor(s * 0.06));
            ctx.fillStyle = metalDark;
            ctx.fillRect(ix - turretLen * 0.12, turretY - Math.floor(s * 0.04), s * 0.09, Math.floor(s * 0.04));

            // Loader's hatch
            ctx.fillStyle = darker;
            ctx.fillRect(ix - turretLen * 0.4, turretY - Math.floor(s * 0.03), s * 0.1, Math.floor(s * 0.04));

            // Main gun mantlet
            ctx.fillStyle = darker;
            ctx.beginPath();
            ctx.moveTo(ix + turretLen * 0.45, turretY + turretH * 0.25);
            ctx.lineTo(ix + turretLen * 0.55, turretY + turretH * 0.4);
            ctx.lineTo(ix + turretLen * 0.55, turretY + turretH * 0.7);
            ctx.lineTo(ix + turretLen * 0.45, turretY + turretH * 0.85);
            ctx.closePath();
            ctx.fill();

            // Main gun barrel (long, with thermal sleeve)
            const gunY = turretY + turretH * 0.45;
            ctx.fillStyle = metal;
            ctx.fillRect(ix + turretLen * 0.5, gunY, gunLen, gunH);
            // Thermal sleeve sections
            ctx.fillStyle = metalDark;
            ctx.fillRect(ix + turretLen * 0.5 + gunLen * 0.15, gunY - 1, gunLen * 0.15, gunH + 2);
            ctx.fillRect(ix + turretLen * 0.5 + gunLen * 0.45, gunY - 1, gunLen * 0.15, gunH + 2);
            // Muzzle brake
            ctx.fillStyle = metalDark;
            ctx.fillRect(ix + turretLen * 0.5 + gunLen - s * 0.06, gunY - Math.floor(s * 0.02), s * 0.08, gunH + Math.floor(s * 0.04));
            // Bore evacuator
            ctx.fillStyle = darker;
            ctx.fillRect(ix + turretLen * 0.5 + gunLen * 0.3, gunY - Math.floor(s * 0.015), s * 0.08, gunH + Math.floor(s * 0.03));

            // Coaxial machine gun
            ctx.fillStyle = metalDark;
            ctx.fillRect(ix + turretLen * 0.48, gunY + gunH + Math.floor(s * 0.02), s * 0.2, Math.max(1, Math.floor(s * 0.025)));

            // Smoke grenade launchers (side of turret)
            ctx.fillStyle = metalDark;
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(ix + turretLen * 0.25 + i * s * 0.06, turretY + turretH * 0.15, s * 0.04, s * 0.08);
            }
        }

        function drawBuilding(ctx, x, y, size, color, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 16);
            const ix = Math.floor(x);
            const iy = Math.floor(y);
            const height = Math.floor(s * 1.6);

            const base = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const shadow = getSpriteColorWithFog(darkenColor(color, 30), fogFactor, ambient, skyColor);
            const highlight = getSpriteColorWithFog(lightenColor(color, 10), fogFactor, ambient, skyColor);
            const roof = getSpriteColorWithFog(darkenColor(color, 45), fogFactor, ambient, skyColor);
            const trim = getSpriteColorWithFog('#444444', fogFactor, ambient, skyColor);
            const windowDark = getSpriteColorWithFog('#223344', fogFactor, ambient, skyColor);
            const windowLit = getSpriteColorWithFog('#c9b46a', fogFactor, ambient, skyColor);

            // Base/ground plate
            ctx.fillStyle = trim;
            ctx.fillRect(ix - Math.floor(s * 0.48), iy - Math.floor(s * 0.08), Math.floor(s * 0.96), Math.floor(s * 0.12));

            // Main block
            ctx.fillStyle = shadow;
            ctx.fillRect(ix - Math.floor(s * 0.45), iy - height, Math.floor(s * 0.32), height - Math.floor(s * 0.08));
            ctx.fillStyle = base;
            ctx.fillRect(ix - Math.floor(s * 0.1), iy - height, Math.floor(s * 0.55), height - Math.floor(s * 0.08));
            ctx.fillStyle = highlight;
            ctx.fillRect(ix + Math.floor(s * 0.42), iy - height, Math.floor(s * 0.05), height - Math.floor(s * 0.08));

            // Roof slab
            ctx.fillStyle = roof;
            ctx.fillRect(ix - Math.floor(s * 0.5), iy - height - Math.floor(s * 0.08), Math.floor(s * 1.0), Math.floor(s * 0.12));

            // Windows
            const rows = 3;
            const cols = 2;
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const wx = ix - Math.floor(s * 0.02) + col * Math.floor(s * 0.2);
                    const wy = iy - height + Math.floor(s * 0.18) + row * Math.floor(s * 0.4);
                    ctx.fillStyle = (row + col) % 2 === 0 ? windowLit : windowDark;
                    ctx.fillRect(wx, wy, Math.floor(s * 0.14), Math.floor(s * 0.18));
                }
            }

            // Door
            ctx.fillStyle = trim;
            ctx.fillRect(ix + Math.floor(s * 0.08), iy - Math.floor(s * 0.34), Math.floor(s * 0.2), Math.floor(s * 0.26));
        }

        function drawHangar(ctx, x, y, size, color, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 20);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            const base = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 25), fogFactor, ambient, skyColor);
            const roof = getSpriteColorWithFog(darkenColor(color, 10), fogFactor, ambient, skyColor);

            // Main structure
            ctx.fillStyle = base;
            ctx.fillRect(ix - s * 0.7, iy - s * 0.4, s * 1.4, s * 0.8);

            // Curved roof
            ctx.fillStyle = roof;
            ctx.fillRect(ix - s * 0.7, iy - s * 0.5, s * 1.4, s * 0.15);

            // Large door opening
            ctx.fillStyle = dark;
            ctx.fillRect(ix - s * 0.4, iy - s * 0.1, s * 0.8, s * 0.5);

            // Door frame
            ctx.fillStyle = getSpriteColorWithFog(darkenColor(color, 15), fogFactor, ambient, skyColor);
            ctx.fillRect(ix - s * 0.45, iy - s * 0.15, s * 0.05, s * 0.55);
            ctx.fillRect(ix + s * 0.4, iy - s * 0.15, s * 0.05, s * 0.55);
        }

        function drawControlTower(ctx, x, y, size, color, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 15);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            const base = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 20), fogFactor, ambient, skyColor);
            const glass = getSpriteColorWithFog('#4a8aaa', fogFactor, ambient, skyColor);

            // Tower base
            ctx.fillStyle = base;
            ctx.fillRect(ix - s * 0.3, iy, s * 0.6, s * 0.4);

            // Tower shaft
            ctx.fillRect(ix - s * 0.2, iy - s * 0.8, s * 0.4, s * 0.8);

            // Control room
            ctx.fillStyle = dark;
            ctx.fillRect(ix - s * 0.4, iy - s * 1.2, s * 0.8, s * 0.4);

            // Windows
            ctx.fillStyle = glass;
            ctx.fillRect(ix - s * 0.35, iy - s * 1.1, s * 0.7, s * 0.2);
        }

        function drawSAMSite(ctx, x, y, size, color, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 14);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            const base = getSpriteColorWithFog(color, fogFactor, ambient, skyColor);
            const dark = getSpriteColorWithFog(darkenColor(color, 25), fogFactor, ambient, skyColor);
            const missile = getSpriteColorWithFog('#888888', fogFactor, ambient, skyColor);

            // Base platform
            ctx.fillStyle = dark;
            ctx.fillRect(ix - s * 0.4, iy - s * 0.1, s * 0.8, s * 0.2);

            // Launcher body
            ctx.fillStyle = base;
            ctx.fillRect(ix - s * 0.25, iy - s * 0.35, s * 0.5, s * 0.25);

            // Missiles (angled up)
            ctx.fillStyle = missile;
            for (let i = 0; i < 4; i++) {
                const mx = ix - s * 0.2 + i * s * 0.12;
                ctx.fillRect(mx, iy - s * 0.6, s * 0.06, s * 0.3);
            }

            // Radar dish
            ctx.fillStyle = dark;
            ctx.beginPath();
            ctx.ellipse(ix, iy - s * 0.7, s * 0.15, s * 0.08, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawHelipad(ctx, x, y, size, color, fogFactor = 0, ambient = 1, skyColor = 0xFFD4A088) {
            ctx.imageSmoothingEnabled = false;
            const s = Math.max(Math.floor(size), 20);
            const ix = Math.floor(x);
            const iy = Math.floor(y);

            const pad = getSpriteColorWithFog('#333333', fogFactor, ambient, skyColor);
            const marking = getSpriteColorWithFog('#ffff00', fogFactor, ambient, skyColor);

            // Pad surface (ellipse for perspective)
            ctx.fillStyle = pad;
            ctx.beginPath();
            ctx.ellipse(ix, iy, s * 0.5, s * 0.25, 0, 0, Math.PI * 2);
            ctx.fill();

            // H marking
            ctx.fillStyle = marking;
            ctx.fillRect(ix - s * 0.2, iy - s * 0.12, s * 0.08, s * 0.24);
            ctx.fillRect(ix + s * 0.12, iy - s * 0.12, s * 0.08, s * 0.24);
            ctx.fillRect(ix - s * 0.12, iy - s * 0.03, s * 0.24, s * 0.06);
        }

        // ============== SPRITE DEFINITIONS ==============

        const sprites = {
            aircraft: [
                { name: 'Helicopter (Player)', draw: drawHelicopter, hasHeading: true, color: '#4a5a4a' },
                { name: 'Attack Helicopter', draw: drawAttackHelicopter, hasHeading: true, color: '#3a4a3a' },
                { name: 'Fighter Jet', draw: drawFighterJet, hasHeading: true, color: '#5a5a6a' },
                { name: 'Transport Plane', draw: drawTransportPlane, hasHeading: true, color: '#6a6a7a' }
            ],
            ground: [
                { name: 'Soldier (Stand)', draw: (ctx, x, y, s, c, h, f, a, sk) => drawSoldier(ctx, x, y, s, c, 'stand', f, a, sk), hasHeading: false, color: '#5a6a4a' },
                { name: 'Soldier (Shoot)', draw: (ctx, x, y, s, c, h, f, a, sk) => drawSoldier(ctx, x, y, s, c, 'shoot', f, a, sk), hasHeading: false, color: '#5a6a4a' },
                { name: 'Tank', draw: (ctx, x, y, s, c, h, f, a, sk) => drawTank(ctx, x, y, s, c, f, a, sk), hasHeading: false, color: '#4a5a3a' }
            ],
            buildings: [
                { name: 'Building', draw: (ctx, x, y, s, c, h, f, a, sk) => drawBuilding(ctx, x, y, s, c, f, a, sk), hasHeading: false, color: '#6a6a6a' },
                { name: 'Hangar', draw: (ctx, x, y, s, c, h, f, a, sk) => drawHangar(ctx, x, y, s, c, f, a, sk), hasHeading: false, color: '#5a5a5a' },
                { name: 'Control Tower', draw: (ctx, x, y, s, c, h, f, a, sk) => drawControlTower(ctx, x, y, s, c, f, a, sk), hasHeading: false, color: '#7a7a7a' },
                { name: 'SAM Site', draw: (ctx, x, y, s, c, h, f, a, sk) => drawSAMSite(ctx, x, y, s, c, f, a, sk), hasHeading: false, color: '#4a5a4a' },
                { name: 'Helipad', draw: (ctx, x, y, s, c, h, f, a, sk) => drawHelipad(ctx, x, y, s, c, f, a, sk), hasHeading: false, color: '#333333' }
            ]
        };

        // ============== RENDERING ==============

        function createSpriteCard(sprite, containerId) {
            const container = document.getElementById(containerId);
            const card = document.createElement('div');
            card.className = 'sprite-card';
            
            const canvas = document.createElement('canvas');
            canvas.className = 'sprite-canvas';
            canvas.width = 150;
            canvas.height = 150;
            canvas.dataset.spriteName = sprite.name;
            canvas.dataset.hasHeading = sprite.hasHeading;
            
            card.innerHTML = `<h3>${sprite.name}</h3>`;
            card.appendChild(canvas);
            card.innerHTML += `<div class="sprite-info">Size: ${settings.size}px</div>`;
            
            container.appendChild(card);
            
            return canvas;
        }

        function renderSprite(canvas, sprite) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = settings.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const x = canvas.width / 2;
            const y = canvas.height / 2 + 20;
            
            camera.angle = settings.camAngle * Math.PI / 180;
            const heading = settings.heading * Math.PI / 180;
            
            sprite.draw(
                ctx, x, y, 
                settings.size, 
                sprite.color || settings.baseColor,
                heading,
                settings.fogFactor,
                settings.ambient,
                settings.skyColor
            );
        }

        function renderAllSprites() {
            document.querySelectorAll('.sprite-canvas').forEach(canvas => {
                const spriteName = canvas.dataset.spriteName;
                const allSprites = [...sprites.aircraft, ...sprites.ground, ...sprites.buildings];
                const sprite = allSprites.find(s => s.name === spriteName);
                if (sprite) {
                    renderSprite(canvas, sprite);
                }
            });
        }

        function renderAngleStrips() {
            const container = document.getElementById('angleStrips');
            container.innerHTML = '';
            
            const headingSprites = sprites.aircraft;
            
            headingSprites.forEach(sprite => {
                const stripDiv = document.createElement('div');
                stripDiv.className = 'sprite-card';
                stripDiv.innerHTML = `<h3>${sprite.name} - 8 Directions</h3>`;
                
                const strip = document.createElement('div');
                strip.className = 'angle-strip';
                
                for (let i = 0; i < 8; i++) {
                    const angle = i * 45;
                    const canvas = document.createElement('canvas');
                    canvas.width = 80;
                    canvas.height = 80;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = settings.bgColor;
                    ctx.fillRect(0, 0, 80, 80);
                    
                    camera.angle = 0;
                    sprite.draw(ctx, 40, 45, 36, sprite.color || settings.baseColor, angle * Math.PI / 180, 0, 1, settings.skyColor);
                    
                    const label = document.createElement('div');
                    label.style.textAlign = 'center';
                    label.style.fontSize = '10px';
                    label.innerHTML = `${angle}°`;
                    
                    const wrapper = document.createElement('div');
                    wrapper.appendChild(canvas);
                    wrapper.appendChild(label);
                    strip.appendChild(wrapper);
                }
                
                stripDiv.appendChild(strip);
                container.appendChild(stripDiv);
            });
        }

        function renderAnimationPreview() {
            const canvas = document.getElementById('animationCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = settings.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const time = performance.now();
            camera.angle = 0;
            
            // Draw all aircraft types flying across
            const aircraftSprites = sprites.aircraft;
            aircraftSprites.forEach((sprite, i) => {
                const x = ((time / 20 + i * 200) % (canvas.width + 200)) - 100;
                const y = 50 + i * 40;
                sprite.draw(ctx, x, y, 40, sprite.color, Math.PI / 2, 0, 1, settings.skyColor);
            });
            
            requestAnimationFrame(renderAnimationPreview);
        }

        function init() {
            // Create sprite cards
            sprites.aircraft.forEach(s => createSpriteCard(s, 'aircraftGrid'));
            sprites.ground.forEach(s => createSpriteCard(s, 'groundGrid'));
            sprites.buildings.forEach(s => createSpriteCard(s, 'buildingGrid'));
            
            // Initial render
            renderAllSprites();
            renderAngleStrips();
            renderAnimationPreview();
            
            // Event listeners
            document.getElementById('sizeSlider').addEventListener('input', (e) => {
                settings.size = parseInt(e.target.value);
                document.getElementById('sizeValue').textContent = settings.size;
                renderAllSprites();
            });
            
            document.getElementById('angleSlider').addEventListener('input', (e) => {
                settings.heading = parseInt(e.target.value);
                document.getElementById('angleValue').textContent = settings.heading;
                renderAllSprites();
            });
            
            document.getElementById('camAngleSlider').addEventListener('input', (e) => {
                settings.camAngle = parseInt(e.target.value);
                document.getElementById('camAngleValue').textContent = settings.camAngle;
                renderAllSprites();
            });
            
            document.getElementById('fogSlider').addEventListener('input', (e) => {
                settings.fogFactor = parseInt(e.target.value) / 100;
                document.getElementById('fogValue').textContent = settings.fogFactor.toFixed(2);
                renderAllSprites();
            });
            
            document.getElementById('ambientSlider').addEventListener('input', (e) => {
                settings.ambient = parseInt(e.target.value) / 100;
                document.getElementById('ambientValue').textContent = settings.ambient.toFixed(2);
                renderAllSprites();
            });
            
            document.getElementById('colorPicker').addEventListener('input', (e) => {
                settings.baseColor = e.target.value;
                renderAllSprites();
            });
            
            document.getElementById('bgSelect').addEventListener('change', (e) => {
                settings.bgColor = e.target.value;
                renderAllSprites();
                renderAngleStrips();
            });
        }
        
        // Start
        init();
    </script>
</body>
</html>
